@page "/exercises-performed/edit/{id:int}"
@using BeFitBlazor.Data
@using BeFitBlazor.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Edit Exercise Log</PageTitle>

<h1>Edit Exercise Log</h1>

@if (exercisePerformed == null || trainingSessions == null || exerciseTypes == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="@exercisePerformed" OnValidSubmit="@HandleValidSubmit" FormName="EditExercisePerformed">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-3">
            <label for="trainingSession" class="form-label">Training Session:</label>
            <InputSelect id="trainingSession" @bind-Value="exercisePerformed.TrainingSessionId" class="form-control">
                <option value="0">-- Select --</option>
                @foreach (var session in trainingSessions)
                {
                    <option value="@session.Id">@session.StartTime.ToString("dd.MM.yyyy HH:mm") - @session.EndTime.ToString("HH:mm")</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => exercisePerformed.TrainingSessionId)" />
        </div>

        <div class="mb-3">
            <label for="exerciseType" class="form-label">Exercise Type:</label>
            <InputSelect id="exerciseType" @bind-Value="exercisePerformed.ExerciseTypeId" class="form-control">
                <option value="0">-- Select --</option>
                @foreach (var type in exerciseTypes)
                {
                    <option value="@type.Id">@type.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => exercisePerformed.ExerciseTypeId)" />
        </div>

        <div class="mb-3">
            <label for="load" class="form-label">Load (kg):</label>
            <InputNumber id="load" @bind-Value="exercisePerformed.Load" class="form-control" step="0.5" />
            <ValidationMessage For="@(() => exercisePerformed.Load)" />
        </div>

        <div class="mb-3">
            <label for="sets" class="form-label">Sets:</label>
            <InputNumber id="sets" @bind-Value="exercisePerformed.Sets" class="form-control" />
            <ValidationMessage For="@(() => exercisePerformed.Sets)" />
        </div>

        <div class="mb-3">
            <label for="repetitions" class="form-label">Repetitions:</label>
            <InputNumber id="repetitions" @bind-Value="exercisePerformed.Repetitions" class="form-control" />
            <ValidationMessage For="@(() => exercisePerformed.Repetitions)" />
        </div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary">Update</button>
            <a href="/exercises-performed" class="btn btn-secondary">Cancel</a>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    private ExercisePerformed? exercisePerformed { get; set; }

    private List<TrainingSession>? trainingSessions;
    private List<ExerciseType>? exerciseTypes;

    protected override async Task OnInitializedAsync()
    {
        var userId = await GetCurrentUserIdAsync();
        
        // Only show user's own training sessions
        trainingSessions = await DbContext.TrainingSessions
            .Where(t => t.UserId == userId)
            .OrderByDescending(t => t.StartTime)
            .ToListAsync();
            
        exerciseTypes = await DbContext.ExerciseTypes
            .OrderBy(e => e.Name)
            .ToListAsync();

        if (exercisePerformed is null)
        {
            exercisePerformed = await DbContext.ExercisePerformeds
                .Include(e => e.TrainingSession)
                .FirstOrDefaultAsync(e => e.Id == Id);
            
            // Verify ownership via training session
            if (exercisePerformed == null || exercisePerformed.TrainingSession.UserId != userId)
            {
                Navigation.NavigateTo("/exercises-performed");
            }
        }
    }

    private async Task<string> GetCurrentUserIdAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        return UserManager.GetUserId(user) ?? string.Empty;
    }

    private async Task HandleValidSubmit()
    {
        if (exercisePerformed != null)
        {
            DbContext.ExercisePerformeds.Update(exercisePerformed);
            await DbContext.SaveChangesAsync();
            Navigation.NavigateTo("/exercises-performed");
        }
    }
}
